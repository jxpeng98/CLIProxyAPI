name: Sync with Upstream

on:
  schedule:
    # æ¯å¤©æ£€æŸ¥ä¸¤æ¬¡upstreamæ›´æ–° (UTCæ—¶é—´ 00:00 å’Œ 12:00)
    - cron: '0 0,12 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          # è·å–forkçš„æºä»“åº“URL
          UPSTREAM_URL=$(gh api repos/${{ github.repository }} --jq '.parent.clone_url // .clone_url')
          
          # å¦‚æœæ²¡æœ‰parentï¼ˆä¸æ˜¯forkï¼‰ï¼Œåˆ™é€€å‡º
          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" = "null" ]; then
            echo "This repository is not a fork, skipping sync."
            exit 0
          fi
          
          echo "Upstream URL: $UPSTREAM_URL"
          git remote add upstream "$UPSTREAM_URL" || git remote set-url upstream "$UPSTREAM_URL"
          git fetch upstream --tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for new upstream tags
        id: check_tags
        run: |
          # è·å–upstreamçš„æœ€æ–°tag
          LATEST_UPSTREAM_TAG=$(git tag -l --sort=-version:refname | grep -v "^v" | head -n 1 || git describe --tags --abbrev=0 upstream/main 2>/dev/null || echo "")
          
          if [ -z "$LATEST_UPSTREAM_TAG" ]; then
            LATEST_UPSTREAM_TAG=$(git describe --tags --abbrev=0 upstream/main 2>/dev/null || echo "none")
          fi
          
          echo "Latest upstream tag: $LATEST_UPSTREAM_TAG"
          
          # è·å–æœ¬åœ°æœ€æ–°åŒæ­¥çš„tag (æ£€æŸ¥æ˜¯å¦å­˜åœ¨sync-upstream-tagæ–‡ä»¶)
          if [ -f .github/sync-upstream-tag ]; then
            LAST_SYNCED_TAG=$(cat .github/sync-upstream-tag)
          else
            LAST_SYNCED_TAG="none"
          fi
          
          echo "Last synced tag: $LAST_SYNCED_TAG"
          
          # æ¯”è¾ƒtags
          if [ "$LATEST_UPSTREAM_TAG" != "$LAST_SYNCED_TAG" ] && [ "$LATEST_UPSTREAM_TAG" != "none" ]; then
            echo "new_tag_found=true" >> $GITHUB_OUTPUT
            echo "latest_tag=$LATEST_UPSTREAM_TAG" >> $GITHUB_OUTPUT
            echo "New upstream tag detected: $LATEST_UPSTREAM_TAG"
          else
            echo "new_tag_found=false" >> $GITHUB_OUTPUT
            echo "No new upstream tags found."
          fi

      - name: Create sync branch and PR
        if: steps.check_tags.outputs.new_tag_found == 'true'
        run: |
          LATEST_TAG="${{ steps.check_tags.outputs.latest_tag }}"
          BRANCH_NAME="sync-upstream-${LATEST_TAG}"
          
          # åˆ›å»ºæ–°åˆ†æ”¯
          git checkout -b "$BRANCH_NAME"
          
          # å°è¯•åˆå¹¶upstream/main
          echo "Attempting to merge upstream/main..."
          if git merge upstream/main --no-edit -m "Merge upstream main (tag: ${LATEST_TAG})"; then
            echo "Merge successful"
            
            # è®°å½•å·²åŒæ­¥çš„tag
            mkdir -p .github
            echo "$LATEST_TAG" > .github/sync-upstream-tag
            git add .github/sync-upstream-tag
            git commit -m "Update sync tag marker to ${LATEST_TAG}" || true
            
            # æ¨é€åˆ†æ”¯
            git push origin "$BRANCH_NAME"
            
            # åˆ›å»ºPull Request
            gh pr create \
              --title "ğŸ”„ Sync with upstream (${LATEST_TAG})" \
              --body "## Upstream Sync

This PR syncs the repository with upstream changes.

**Upstream Tag:** \`${LATEST_TAG}\`
**Source:** upstream/main

### Changes
This PR includes all changes from the upstream main branch up to tag \`${LATEST_TAG}\`.

Please review the changes carefully before merging.

---
*This PR was automatically created by the sync-upstream workflow.*" \
              --base main \
              --head "$BRANCH_NAME" \
              --label "upstream-sync"
            
            echo "Pull request created successfully!"
          else
            echo "Merge conflicts detected. Manual intervention required."
            
            # å³ä½¿æœ‰å†²çªï¼Œä¹Ÿæ¨é€åˆ†æ”¯
            git push origin "$BRANCH_NAME" || true
            
            # åˆ›å»ºPRè¯´æ˜æœ‰å†²çª
            gh pr create \
              --title "âš ï¸ Sync with upstream (${LATEST_TAG}) - CONFLICTS" \
              --body "## Upstream Sync - Manual Resolution Required

This PR attempts to sync the repository with upstream changes but encountered **merge conflicts**.

**Upstream Tag:** \`${LATEST_TAG}\`
**Source:** upstream/main

### âš ï¸ Action Required
Please resolve the merge conflicts manually:

\`\`\`bash
git fetch origin
git checkout $BRANCH_NAME
git merge upstream/main
# Resolve conflicts
git add .
git commit
git push origin $BRANCH_NAME
\`\`\`

---
*This PR was automatically created by the sync-upstream workflow.*" \
              --base main \
              --head "$BRANCH_NAME" \
              --label "upstream-sync,conflicts" || echo "Failed to create PR, branch may already exist"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_tags.outputs.new_tag_found }}" = "true" ]; then
            echo "âœ… New upstream tag detected and PR created: ${{ steps.check_tags.outputs.latest_tag }}"
          else
            echo "â„¹ï¸ No new upstream tags found. Repository is up to date."
          fi
