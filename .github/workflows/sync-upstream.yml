name: Sync with Upstream

on:
  schedule:
    # 每天检查两次upstream更新 (UTC时间 00:00 和 12:00)
    - cron: '0 0,12 * * *'
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write
  pull-requests: write

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          UPSTREAM_URL=$(gh api repos/${{ github.repository }} --jq '.parent.clone_url // .clone_url')

          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" = "null" ]; then
            echo "This repository is not a fork, skipping sync."
            exit 0
          fi

          echo "Upstream URL: $UPSTREAM_URL"
          git remote add upstream "$UPSTREAM_URL" || git remote set-url upstream "$UPSTREAM_URL"
          git fetch upstream --tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for new upstream tags
        id: check_tags
        run: |
          LATEST_UPSTREAM_TAG=$(git ls-remote --tags upstream | awk '{print $2}' | sed 's#refs/tags/##' | grep -v '\^{}' | sort -Vr | head -n 1 || echo "")

          if [ -z "$LATEST_UPSTREAM_TAG" ]; then
            LATEST_UPSTREAM_TAG=$(git describe --tags --abbrev=0 upstream/main 2>/dev/null || echo "none")
          fi

          echo "Latest upstream tag: $LATEST_UPSTREAM_TAG"

          if [ -f .github/sync-upstream-tag ]; then
            LAST_SYNCED_TAG=$(cat .github/sync-upstream-tag)
          else
            LAST_SYNCED_TAG="none"
          fi

          echo "Last synced tag: $LAST_SYNCED_TAG"

          if [ "$LATEST_UPSTREAM_TAG" != "$LAST_SYNCED_TAG" ] && [ "$LATEST_UPSTREAM_TAG" != "none" ]; then
            echo "new_tag_found=true" >> $GITHUB_OUTPUT
            echo "latest_tag=$LATEST_UPSTREAM_TAG" >> $GITHUB_OUTPUT
            echo "New upstream tag detected: $LATEST_UPSTREAM_TAG"
          else
            echo "new_tag_found=false" >> $GITHUB_OUTPUT
            echo "No new upstream tags found."
          fi

      - name: Create sync branch and PR
        if: steps.check_tags.outputs.new_tag_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          LATEST_TAG="${{ steps.check_tags.outputs.latest_tag }}"
          BRANCH_NAME="sync-upstream-${LATEST_TAG}"

          git fetch upstream main
          git checkout -B "$BRANCH_NAME" upstream/main

          mkdir -p .github
          echo "$LATEST_TAG" > .github/sync-upstream-tag
          git add .github/sync-upstream-tag
          git commit -m "Track upstream sync tag ${LATEST_TAG}" --allow-empty

          git push --force origin "$BRANCH_NAME"

          PR_BODY=$(cat <<EOF2
## Upstream Sync

This PR syncs the repository with upstream changes.

**Upstream Tag:** \`${LATEST_TAG}\`
**Source:** upstream/main

### Changes
This PR includes all changes from the upstream main branch up to tag \`${LATEST_TAG}\`.

Please review the changes carefully before merging.

---
*This PR was automatically created by the sync-upstream workflow.*
EOF2
)

          EXISTING_PR=$(gh pr list --state open --head "$BRANCH_NAME" --base main --json number --jq '.[0].number' || true)

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for $BRANCH_NAME."
          else
            gh pr create \
              --title "Sync with upstream (${LATEST_TAG})" \
              --body "$PR_BODY" \
              --base main \
              --head "$BRANCH_NAME" \
              --label "upstream-sync"
          fi

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_tags.outputs.new_tag_found }}" = "true" ]; then
            echo "[OK] Checked upstream tag: ${{ steps.check_tags.outputs.latest_tag }}"
          else
            echo "[INFO] No new upstream tags found. Repository is up to date."
          fi
